# `train` - Train deep learning networks

This functionality enables the training of a network using
different formats of inputs (whole 3D images, 3D patches or 2D slices), as defined in
[[Wen et al., 2020](https://doi.org/10.1016/j.media.2020.101694)].
It mainly relies on the PyTorch deep learning library
[[Paszke et al., 2019](https://papers.nips.cc/paper/9015-pytorch-an-imperative-style-high-performance-deep-learning-library)].

Different tasks can be learnt by a network: `classification`, `reconstruction` and `regression` (see below).

## Prerequisites
You need to execute the [`clinicadl tsvtool getlabels`](../TSVTools.md#getlabels---extract-labels-specific-to-alzheimers-disease) 
and [`clinicadl tsvtool {split|kfold}`](../TSVTools.md#split---single-split-observing-similar-age-and-sex-distributions) commands
prior to running this task to have the correct TSV file organization.
Moreover, there should be a CAPS, obtained running the preprocessing pipeline wanted.

## Running the task
The training task can be run with the following command line:
```
clinicadl train <mode> <network_task> <caps_directory> \
                <preprocessing> <tsv_path> <output_directory>
```
where mandatory arguments are:

- `mode` (str) is the type of input used. Must be chosen between `image`, `patch`, `roi` and `slice`.
- `network_task` (str) is the type of task learnt by the network.
Available tasks are `classification`, `regression` and `reconstruction`.
- `caps_directory` (str) is the input folder containing the neuroimaging data in a [CAPS](https://aramislab.paris.inria.fr/clinica/docs/public/latest/CAPS/Introduction/) hierarchy.
In case of [multi-cohort training](Details.md#multi-cohort), must be a path to a TSV file.
- `preprocessing` (str) corresponds to the preprocessing pipeline whose outputs will be used for training. 
- `tsv_path` (str) is the input folder of a TSV file tree generated by `clinicadl tsvtool {split|kfold}`.
In case of [multi-cohort training](Details.md#multi-cohort), must be a path to a TSV file.
- `output_directory` (str) is the folder where the results are stored.

!!! tip "`from_json` mode"
    To shorten the command line, the option [`from_json`](Retrain.md) was added to `clinicadl train` in order
    to define all the arguments in a JSON file.
    In the future ClinicaDL will only rely on configuration files to avoid a too long command line.

Options shared for all values of `mode` and `network_task` are organized in groups:

- **Architecture management**
    - `--model` (str) is the name of the architecture used. Default depends on the task.
    It must correspond to a class that inherits from `nn.Module` imported in `tools/deep_learning/models/__init__.py`.
    To implement custom models please refer to [this section](../Contribute/Custom.md#custom-architecture).
    - `--multi` (bool) is a flag to ask for a [multi-network framework](./Details.md#multi-cohort).
    Default trains only one network on all images.
    - `--dropout` (float) is the rate of dropout applied in dropout layers. Default: `0`.

!!! warning "architecture limitations"
    Depending on the task, the output size needed to learn the task may vary:
        - for `classification` the network must output a vector of length equals to the number of classes,
        - for `regression` the network has only one output node,
        - for `reconstruction` the network outputs an image of the same size as the input.
    If you want to use custom architecture, be sure to respect the output size needed for the learnt task.

- **Computational resources**
    - `--use_cpu` (bool) forces to use CPU. Default behaviour is to try to use a GPU and to raise an error if it is not found.
    - `--nproc` (int) is the number of workers used by the DataLoader. Default value: `2`.
    - `--batch_size` (int) is the size of the batch used in the DataLoader. Default value: `2`.
    - `--evaluation_steps` (int) gives the number of iterations to perform an [evaluation internal to an epoch](Details.md#evaluation). 
    Default will only perform an evaluation at the end of each epoch.
- **Data management**
    - `--diagnoses` (list of str) is the list of the labels that will be used for training. 
    These labels must be chosen from {AD,CN,MCI,sMCI,pMCI}. Default will use AD and CN labels.
    - `--baseline` (bool) is a flag to load only `_baseline.tsv` files instead of `.tsv` files comprising all the sessions. Default: `False`.
    - `--unnormalize` (bool) is a flag to disable min-max normalization that is performed by default. Default: `False`.
    - `--data_augmentation` (list of str) is the list of data augmentation transforms applied to the training data.
    Must be chosen in [`None`, `Noise`, `Erasing`, `CropPad`, `Smoothing`]. Default: `False`.
    - `--sampler` (str) is the sampler used on the training set. It must be chosen in [`random`, `weighted`]. 
    `weighted` will give a stronger weight to underrepresented classes. Default: `random`.
    - `--multi_cohort` (bool) is a flag indicated that [multi-cohort training](Details.md#multi-cohort) is performed.
    In this case, `caps_directory` and `tsv_path` must be paths to TSV files.
- **Cross-validation arguments**
    - `--n_splits` (int) is a number of splits k to load in the case of a k-fold cross-validation. Default will load a single-split.
    - `--folds` (list of int) is a subset of folds that will be used for training. By default all splits available are used. 
- **Optimization parameters**
    - `--epochs` (int) is the [maximum number of epochs](Details.md#stopping-criterion). Default: `20`.
    - `--learning_rate` (float) is the learning rate used to perform weight update. Default: `1e-4`.
    - `--weight_decay` (float) is the weight decay used by the Adam optimizer. Default: `1e-4`.
    - `--patience` (int) is the number of epochs for [early stopping](Details.md#stopping-criterion) patience. Default: `0`.
    - `--tolerance` (float) is the value used for [early stopping](Details.md#stopping-criterion) tolerance. Default: `0`.
    - `--accumulation_steps` (int) gives the number of iterations during which gradients are accumulated before performing the [weights update](Details.md#optimization). 
    This allows to virtually increase the size of the batch. Default: `1`.

!!! note "preprocessing & mode specific options"
    Preprocessing options are the same than those of `clinicadl preprocessing extract-tensor`.
    Please refer to [the corresponding section](../Preprocessing/Extract.md) for more information on these options.

!!! tip
    Typing `clinicadl train {image|patch|roi|slice} {classification|reconstruction|regression} --help`
    will show you the list of options needed depending on the mode and the task.


A few options depend on the task performed:

- **classification**
    The objective of the `classification` is to attribute a class to input images.
    The criterion loss is the cross entropy between the ground truth and the network output.
    The evaluation metrics are the accuracy, sensitivity, specificity, positive predictive value (PPV),
    negative predictive value (NPV) and balanced accuracy (BA).
    - `--label` (str) is the name of the column containing the label for the classification task.
    It must be a categorical variable, but may be of any type. Default: `diagnosis`.
    - --selection_threshold` (float) threshold on the balanced accuracies to compute the
    [image-level performance](./Details.md#image-level-results).
    Parts of the image are selected if their balanced accuracy is greater than the threshold.
    Default corresponds to no selection.
- **regression**
    The objective of the `regression` is to learn the value of a continuous variable given an image.
    The criterion loss is the mean squared error between the ground truth and the network output.
    The evaluation metrics are the mean squared error (MSE) and mean absolute error (MAE).
    - `--label` (str) is the name of the column containing the label for the regression task.
    It must be a continuous variable (float or int). Default: `age`.
- **reconstruction**
    The objective of the `reconstruction` is to learn to reconstruct images given in input.
    The criterion loss is the mean squared error between the input and the network output.
    The evaluation metrics are the mean squared error (MSE) and mean absolute error (MAE).

    - `--visualization` (bool) if this flag is given, inputs of the train and
    the validation sets corresponding to one image and their corresponding reconstructions are written in the MAPS.
    See the section on [tensor serialization](../Tensors.md#outputs) for more insight on the output structure.

## Outputs

The `clinicadl train` command outputs a [MAPS file system](../Introduction.md#maps-definition) in which there are only two data groups: `train` and `validation`.
To limit the size of the MAPS produced, tensor inputs and outputs of each group are only produced thanks to one image of the data set
(for more information on input and output tensor serialization report to [the dedicated section](../Tensor.md)).
