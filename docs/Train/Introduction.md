# `train` - Train deep learning networks for neuroimaging classification

This task enables the training of a convolutional neural network (CNN) classifier or an autoencoder using 
different formats of inputs  (whole 3D images, 3D patches or 2D slices), as defined in 
[[Wen et al., 2020](https://doi.org/10.1016/j.media.2020.101694)]. 
It mainly relies on the PyTorch deep learning library 
[[Paszke et al., 2019](https://papers.nips.cc/paper/9015-pytorch-an-imperative-style-high-performance-deep-learning-library)].

## Prerequisites
You need to execute the [`clinicadl tsvtool getlabels`](../TSVTools.md#getlabels---extract-labels-specific-to-alzheimers-disease) 
and [`clinicadl tsvtool {split|kfold}`](../TSVTools.md#split---single-split-observing-similar-age-and-sex-distributions) commands
prior to running this task to have the correct TSV file organization.
Moreover, there should be a CAPS, obtained running the preprocessing pipeline wanted.

!!! note "Parcellation prediction"
    It is now possible to predict the intensities in different regions of a neuroanatomical atlas
    with the binary classification task. In this case the outputs of the preprocessing pipeline
    `clinica run t1-volume` must exist in the CAPS.
    

## Running the task
The training task can be run with the following command line:
```
clinicadl train <mode> <network_type> <caps_directory> \
                <preprocessing> <tsv_path> <output_directory> <architecture>
```
where mandatory arguments are:

- `mode` (str) is the type of input used. Must be chosen between `image`, `patch`, `roi` and `slice`.
- `network_type` (str) is the type of network used. 
The options depend on the type of input used, but at most it can be chosen between `autoencoder`, `cnn` and `multicnn`.
- `caps_directory` (str) is the input folder containing the neuroimaging data in a [CAPS](https://aramislab.paris.inria.fr/clinica/docs/public/latest/CAPS/Introduction/) hierarchy.
In case of [multi-cohort training](Details.md#multi-cohort), must be a path to a TSV file.
- `preprocessing` (str) corresponds to the preprocessing pipeline whose outputs will be used for training. 
- `tsv_path` (str) is the input folder of a TSV file tree generated by `clinicadl tsvtool {split|kfold}`.
In case of [multi-cohort training](Details.md#multi-cohort), must be a path to a TSV file.
- `output_directory` (str) is the folder where the results are stored.
- `architecture` (str) is the name of the architecture used (e.g. `Conv5_FC3`). 
It must correspond to a class that inherits from `nn.Module` imported in `tools/deep_learning/models/__init__.py`.

!!! tip "`from_json` mode"
    To shorten the command line, the option [`from_json`](Retrain.md) was added to `clinicadl train` in order
    to define all the arguments in a JSON file.

Options shared for all values of `mode` are organized in groups:

- **Computational resources**
    - `--use_cpu` (bool) forces to use CPU. Default behaviour is to try to use a GPU and to raise an error if it is not found.
    - `--nproc` (int) is the number of workers used by the DataLoader. Default value: `2`.
    - `--batch_size` (int) is the size of the batch used in the DataLoader. Default value: `2`.
    - `--evaluation_steps` (int) gives the number of iterations to perform an [evaluation internal to an epoch](Details.md#evaluation). 
    Default will only perform an evaluation at the end of each epoch.
- **Data management**
    - `--diagnoses` (list of str) is the list of the labels that will be used for training. 
    These labels must be chosen from {AD,CN,MCI,sMCI,pMCI}. Default will use AD and CN labels.
    - `--baseline` (bool) is a flag to load only `_baseline.tsv` files instead of `.tsv` files comprising all the sessions. Default: `False`.
    - `--unnormalize` (bool) is a flag to disable min-max normalization that is performed by default. Default: `False`.
    - `--data_augmentation` (list of str) is the list of data augmentation transforms applied to the training data.
    Must be chosen in [`None`, `Noise`, `Erasing`, `CropPad`, `Smoothing`]. Default: `False`.
    - `--sampler` (str) is the sampler used on the training set. It must be chosen in [`random`, `weighted`]. 
    `weighted` will give a stronger weight to underrepresented classes. Default: `random`.
    - `--multi_cohort` (bool) is a flag indicated that [multi-cohort training](Details.md#multi-cohort) is performed.
    In this case, `caps_directory` and `tsv_path` must be paths to TSV files.
    - `--predict_atlas_intensities` (str) corresponds to a neuroanatomical atlas.
    If given the network learns to compute the grey matter intensity
    according to this atlas. The number of output nodes will be 2 + number of regions in the atlas.
    Must be chosen in the following list: AAL2, AICHA, Hammers, LPBA40, "Neuromorphometrics.
    - `--atlas_weight` (float) is the weight put on the MSE loss computed to learn the grey matter intensities
    when added to the cross-entropy loss. Default: `1`.
    -  `--merged_tsv_path` (str) is the path to the output of `clinica iotools merged-tsv` (or the concatenation
    of the outputs in case of multi-cohort framework). Giving this file can accelerate the computation when
    computing the grey matter intensities.
- **Cross-validation arguments**
    - `--n_splits` (int) is a number of splits k to load in the case of a k-fold cross-validation. Default will load a single-split.
    - `--folds` (list of int) is a subset of folds that will be used for training. By default all splits available are used. 
- **Optimization parameters**
    - `--epochs` (int) is the [maximum number of epochs](Details.md#stopping-criterion). Default: `20`.
    - `--learning_rate` (float) is the learning rate used to perform weight update. Default: `1e-4`.
    - `--weight_decay` (float) is the weight decay used by the Adam optimizer. Default: `1e-4`.
    - `--dropout` (float) is the rate of dropout applied in dropout layers. Default: `0`.
    - `--patience` (int) is the number of epochs for [early stopping](Details.md#stopping-criterion) patience. Default: `0`.
    - `--tolerance` (float) is the value used for [early stopping](Details.md#stopping-criterion) tolerance. Default: `0`.
    - `--accumulation_steps` (int) gives the number of iterations during which gradients are accumulated before performing the [weights update](Details.md#optimization). 
    This allows to virtually increase the size of the batch. Default: `1`.

!!! note "Specific options"
    Other options are highly dependent on the input and the type of network used. 
    Please refer to the corresponding sections for more information.

!!! tip
    Typing `clinicadl train {image|patch|roi|slice} --help` will show you the networks that are available for training in this category.

## Outputs

The `clinicadl train` command outputs a [MAPS file system]() in which there are only two data groups: `train` and `validation`.
To limit the size of the MAPS produced, tensor inputs and outputs of each group are only produced thanks to one image of the data set
(for more information on input and output tensor serialization report to [the dedicated section](../Tensor.md)).
