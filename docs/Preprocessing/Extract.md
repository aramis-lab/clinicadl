# `extract-tensor` - Prepare input data for deep learning with PyTorch

This pipeline prepares images generated by Clinica to be used with the PyTorch deep learning library
[[Paszke et al., 2019](https://papers.nips.cc/paper/9015-pytorch-an-imperative-style-high-performance-deep-learning-library)].
Three types of tensors are proposed: 3D images, 3D patches or 2D slices.

Currently, only outputs from the [`t1-linear` pipeline](T1_Linear.md) can be processed.

## Prerequisites
<!-- Depending on the type of feature or the type of modality you want to use, you will need to execute either the [`t1-linear` pipeline](../T1_Linear) , the [`t1-volume` pipeline](../T1_Volume) and/or the [`pet-volume` pipeline](../PET_Volume)  prior to running this pipeline. -->

You need to have performed the [`t1-linear` pipeline](T1_Linear.md) on your T1-weighted MRI.

## Running the pipeline
The pipeline can be run with the following command line:
```Text
clinicadl preprocessing extract-tensor <preprocessing> <caps_directory> <tsv_file> <working_dir> <tensor_format>
```

where:

- `preprocessing` (str) corresponds to the preprocessing pipeline whose outputs will be formatted.
- `caps_directory` (str) is the folder containing the results of the [`t1-linear` pipeline](T1_Linear.md)
and the output of the present command, both in a [CAPS hierarchy](http://www.clinica.run/doc/CAPS/Introduction).
- `tsv_file` (str) is the TSV file with subjects/sessions to process.
- `working_dir` (str) is the working directory to save temporary file.
- `tensor_format` (str) is the format of the extracted tensors.
You can choose between `image` to convert to PyTorch tensor the whole 3D image,
`patch` to extract 3D patches and `slice` to extract 2D slices from the image.

<!--By default the features are extracted from the cropped image (see the documentation of the [`t1-linear` pipeline](../T1_Linear)). You can deactivate this behaviour with the `--use_uncropped_image` flag.

Pipeline options if you use `patch` extraction:

- `--patch_size`: (int) patch size. Default value: `50`.
- `--stride_size`:  (int) stride size. Default value: `50`.

Pipeline options if you use `slice` extraction:

- `--slice_direction`: (int) slice direction. 
You can choose between `0` (sagittal plane), `1`(coronal plane) or `2` (axial plane). 
Default value: `0`.
- `--slice_mode`: (str) slice mode. 
You can choose between `rgb` (will save the slice in three identical channels) 
or `single` (will save the slice in a single channel). Default value: `rgb`.-->

!!! note "Regarding the default values"
	When using patch or slice extraction, default values were set according to [[Wen et al., 2020](https://doi.org/10.1016/j.media.2020.101694)].

??? info "The full list of options available for tensor extraction"
    ```{.sourceCode .bash}

    usage: clinicadl preprocessing extract-tensor [-h] [-ps PATCH_SIZE]
                                              [-ss STRIDE_SIZE]
                                              [-sd SLICE_DIRECTION]
                                              [-sm {single,rgb}] [-np NPROC]
                                              {t1-linear} caps_dir tsv_file
                                              working_dir {image,patch,slice}

    positional arguments:
      {t1-linear}           Preprocessing pipeline on which extraction is
                            performed.
      caps_dir              Data using CAPS structure.
      tsv_file              TSV file with subjects/sessions to process.
      working_dir           Working directory to save temporary file.
      {image,patch,slice}   Method used to extract features. Three options:
                            'image' to conver to PyTorch tensor the complete 3D
                            image, 'patch' to extract 3D volumetric patches or
                            'slice' to get 2D slices from the image.

    optional arguments:
      -h, --help            show this help message and exit
      -ps PATCH_SIZE, --patch_size PATCH_SIZE
                            Patch size (only for 'patch' extraction) e.g:
                            --patch_size 50
      -ss STRIDE_SIZE, --stride_size STRIDE_SIZE
                            Stride size (only for 'patch' extraction) e.g.:
                            --stride_size 50
      -sd SLICE_DIRECTION, --slice_direction SLICE_DIRECTION
                            Slice direction (only for 'slice' extraction). Three
                            options: '0' -> Sagittal plane, '1' -> Coronal plane
                            or '2' -> Axial plane
      -sm {single,rgb}, --slice_mode {single,rgb}
                            Slice mode (only for 'slice' extraction). Two options:
                            'single' to save the slice in one single channel,
                            'rgb' to save the slice in three identical channel.
      -np NPROC, --nproc NPROC
                            Number of cores used for processing
    ```

## Outputs
In the following subsections, files with the `.pt` extension denote tensors in PyTorch format.

The full list of output files can be found in the
[ClinicA Processed Structure (CAPS) Specification](http://www.clinica.run/doc/CAPS/Specifications/#deeplearning-prepare-data-prepare-input-data-for-deep-learning-with-pytorch).

### Image-based outputs
Results are stored in the following folder of the [CAPS hierarchy](http://www.clinica.run/doc/CAPS/Introduction):
`subjects/<subject_id>/<session_id>/deeplearning_prepare_data/image_based/t1_linear`.

The main output files are:

- `<source_file>_space-MNI152NLin2009cSym[_desc-Crop]_res-1x1x1_T1w.pt`: tensor version of the 3D T1w image registered to the
[`MNI152NLin2009cSym` template](https://bids-specification.readthedocs.io/en/stable/99-appendices/08-coordinate-systems.html)
and optionally cropped.

### Patch-based outputs

Results are stored in the following folder of the [CAPS hierarchy](http://www.clinica.run/doc/CAPS/Introduction/):
`subjects/<subject_id>/<session_id>/deeplearning_prepare_data/patch_based/t1_linear`.

The main output files are:

- `<source_file>_space-MNI152NLin2009cSym[_desc-Crop]_res-1x1x1_patchsize-<N>_stride-<M>_patch-<i>_T1w.pt`:
tensor version of the `<i>`-th 3D isotropic patch of size `<N>` with a stride of `<M>`.
Each patch is extracted from the T1w image registered to the
[`MNI152NLin2009cSym` template](https://bids-specification.readthedocs.io/en/stable/99-appendices/08-coordinate-systems.html)
and optionally cropped.

### Slice-based outputs

Results are stored in the following folder of the [CAPS hierarchy](http://www.clinica.run/doc/CAPS/Introduction/):
`subjects/<subject_id>/<session_id>/deeplearning_prepare_data/slice_based/t1_linear`.

The main output files are:

- `<source_file>_space-MNI152NLin2009cSym[_desc-Crop]_res-1x1x1_axis-{sag|cor|axi}_channel-{single|rgb}_T1w.pt`:
tensor version of the `<i>`-th 2D slice in `sag`ittal, `cor`onal or `axi`al plane using three identical channels (`rgb`)
or one channel (`single`). Each slice is extracted from the T1w image registered to the
[`MNI152NLin2009cSym` template](https://bids-specification.readthedocs.io/en/stable/99-appendices/08-coordinate-systems.html)
and optionally cropped.


## Describing this pipeline in your paper

!!! cite "Example of paragraph"
    These results have been obtained using the `deeplearning-prepare-data` pipeline of Clinica
    [[Routier et al.](https://hal.inria.fr/hal-02308126/); [Wen et al., 2020](https://doi.org/10.1016/j.media.2020.101694)].
    More precisely,

    - 3D images

    - 3D patches with patch size of `<patch_size>` and stride size of `<stride_size>`

    - 2D slices in {sagittal | coronal | axial} plane and saved in {three identical channels | a single channel}

    were extracted and converted to PyTorch tensors [[Paszke et al., 2019](https://papers.nips.cc/paper/9015-pytorch-an-imperative-style-high-performance-deep-learning-library)].
